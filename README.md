# youtube-clipper

Tool for finding clips in YouTube videos. Supports searching in multiple videos, e.g. in playlists or channels.

YouTube Clipper (YTC) download subtitles (without videos themselves) using [yt-dlp](https://github.com/yt-dlp/yt-dlp), parses them using provided parsers and converters and performs the search using [whoosh](https://whoosh.readthedocs.io). 

## Installation from source

1. Clone the repository: `git clone git@github.com:MCPN/youtube-clipper.git`.
2. Install poetry: `pip install poetry`.
3. Install `youtube-clipper` using `poetry`: `cd youtube-clipper && poetry install`.
4. To install tests dependencies, run `poetry install --with tests`.

## Usage

Basic usage: `youtube-clipper --url https://www.youtube.com/watch?v=dQw4w9WgXcQ --query 'were no strangers to love' --allow-autogenerated`.

There are two groups of additional arguments:
1. yt-dlp arguments are passed almost directly to the yt-dlp client and are related to downloaded subtitles
2. Searcher arguments are used after the download and control the search process and postprocessing.

For a full list of settings, run `youtube-clipper --help`.

## Downloading subtitles

By default, yt-dlp will only look for manual subtitles. By adding the `--allow-autogenerated` option, one allows yt-dlp to download autogenerated subtitles, however the manual ones are always preferred.

Despite YouTube only showing autogenerated subtitles in one language, there are often many translated versions in yt-dlp result, so one can search in a language that is completely different from the one in a video. For example, `youtube-clipper --url https://www.youtube.com/watch?v=dQw4w9WgXcQ --query 'нам не чужда любовь' --allow-autogenerated --language ru --search-limit 1` surprisingly outputs the correct result.

However, one should note that autogenerated subtitles can be faulty, are often censored of an obscene language and contain marks like `[Music]`, so exact searches over autogenerated subtitles are not recommended.

## Query language

The query argument supports the whoosh query language that can be found in the [official documentation](https://whoosh.readthedocs.io/en/latest/querylang.html). Some key points:

* By default, the searcher doesn't require all words to appear in the result, with more matched word resulting in a better overall match. To search for an exact phrase, one can wrap a query in `"double quotes"` (be careful with bash escaping!)
* While using the phrase search, one can allow words to be on a certain distance from each other `"like this"~5` (now `like` can be within 5 words from `this`)
* On the other hand, while allowing imperfect search, one can boost or lower the importance of a certain word using the `^` operator. For example, in query `i^2 love cookies^0.5` the word `i` is twice as important as the word `love` while the word `cookies` is half as important

## Pairwise grouping and deduplication

Searcher treats every separate subtitle (i.e. the phrase that appears on a screen at a singular moment) as its own document. The problem occurs when a phrase is split between two subtitles, in this case the exact search will fail and the regular one might be inaccurate.

To deal with it, one can enable pairwise grouping for the subtitles with the `--enable-pairwise-group` option. When enabled, every successive overlapping subtitle pair will be merged into one subtitle, and search will be performed on new subtitles.

Note that autogenerated subtitles are already have overlaps in them, so the pairwise grouping is excessive for them.

The downside of using the pairwise grouping are duplicates in the output: indeed, search query can match a common part of new subtitles. The `--deduplication-mode` allows to remove these duplicates:
* When set to `--keep-first`, if two consecutive subtitles are in the result, only the first one will be kept. This also applies to a chain of more than two consecutive subtitles
* When set to `--keep-last`, the last subtitle in a consecutive chain will be kept
* When set to `--disable`, the deduplication is skipped

By default, the pairwise grouping is disabled and deduplication with the keep first mode is enabled. When searching in manual subtitles, the pairwise grouping is highly recommended, and as for the deduplication, the keep first mode is preferred because the keep last mode can result in a timestamp that points after the phrase.

## Development

### Parsers and converters

There is an easy API for adding new subtitle formats to  YTC. To do so, one should implement a parser interface at `youtube_clipper.parsers.model:SubtitleParser` and add the implementation to the registry at `youtube_clipper.parsers.model:PARSERS_REGISTRY`.

Alternatively, one can implement a converter for currently unsupported format that will output a new file with an existing parser for it. This is done similarly to parsers, one should implement a parser interface at `youtube_clipper.converters.model:SubtitlesConverter` and add the implementation to the registry at `youtube_clipper.converters.model:CONVERTERS_REGISTRY`. Tests ensure that every converter has a corresponding parser.

### Tests

Testing is done using pytest: `pytest tests`.

Type checking is done using mypy: `mypy youtube_clipper`. However, it's not very efficient, as most of the dependencies doesn't have stubs.
