import argparse
import tempfile

import colorama
from colorama import Fore

from youtube_clipper.downloader import SubtitlesDownloader
from youtube_clipper.searcher import SubtitlesSearcher


def main() -> None:
    parser = argparse.ArgumentParser('youtube-clipper')
    parser.add_argument(
        '--url',
        required=True,
        help='youtube URL. Can be any link supported by yt-dlp: a video, a channel, a playlist, etc.\n'
             'In case of multiple videos, search will be performed in every video independently',
    )
    parser.add_argument('--query', required=True, help='Query to search for')

    yt_dlp_args = parser.add_argument_group('yt-dlp arguments')
    yt_dlp_args.add_argument(
        '--formats',
        nargs='*',
        help='subtitles formats to download. By default, only srt and ttml are supported',
    )
    yt_dlp_args.add_argument('--language', default='en', help='subtitles language')
    yt_dlp_args.add_argument('--subs-dir', required=False, help='if specified, subs will be saved to a provided dir')
    yt_dlp_args.add_argument('--allow-autogenerated', action='store_true', help='allow to download autogenerated subs')
    yt_dlp_args.add_argument('--verbose', action='store_true', help='print debug info from yt-dlp')
    yt_dlp_args.add_argument('--quiet', action='store_true', help='hide an output from yt-dlp')

    searcher_args = parser.add_argument_group('searcher arguments')
    searcher_args.add_argument(
        '--show-scores',
        action='store_true',
        help='if set, will show a search score next to a link',
    )
    searcher_args.add_argument('--search-limit', required=False, type=int, help='limit for search results per video')
    searcher_args.add_argument(
        '--deduplication-range',
        required=False,
        type=float,
        help='if set, will deduplicate results with offsets within provided range',
    )

    args = parser.parse_args()
    colorama.init(autoreset=True)

    with tempfile.TemporaryDirectory() as tempdir:
        subs_dir = args.subs_dir or tempdir
        downloader = SubtitlesDownloader(
            language=args.language,
            formats=args.formats or ['srt', 'ttml', 'vtt'],
            allow_autogenerated=args.allow_autogenerated,
            output_dir=subs_dir,
            verbose=args.verbose,
            quiet=args.quiet,
        )

        for filename in downloader.get_subtitles(args.url):
            video_url = downloader.get_url_from_filename(filename)
            print(Fore.YELLOW + f'Searching for "{args.query}" in {video_url}')

            searcher = SubtitlesSearcher(
                index_directory=tempdir,
                limit=args.search_limit,
                deduplication_range=args.deduplication_range,
            )
            searcher.add_subtitles(filename)
            results = searcher.search(args.query)
            if not results:
                print(Fore.RED + f'`{args.query}` wasn\'t found in {video_url}')
            else:
                print(Fore.GREEN + f'Found {len(results)} (approximate) occurrences of `{args.query}` in {video_url}')
                for result in results:
                    score_str = Fore.RESET + f'(score: {result.score})' if args.show_scores else ''
                    print(Fore.GREEN + f'{video_url}&t={int(result.offset)}s {score_str}')


if __name__ == '__main__':
    main()
